name: Build & Push to ACR (Auto-deploy via Web App CD)

on:
  push:
    branches: [ "master" ]

jobs:
  build-push-test:
    runs-on: ubuntu-latest
    steps:
      # 0) Ø³ÙˆØ±Ø³
      - name: Checkout
        uses: actions/checkout@v4

      # 1) Login Ø¨Ù‡ ACR Ø¨Ø§ Admin User
      #    Ø¯Ø± Ø±ÛŒÙ¾Ùˆ Ø¯Ùˆ Ø³Ú©Ø±Øª Ø¨Ø³Ø§Ø²: ACR_USERNAME , ACR_PASSWORD
      - name: Login to ACR
        uses: docker/login-action@v3
        with:
          registry: eshopweb2025.azurecr.io
          username: '$(secrets.ACR_USERNAME)'
          password: '$(secrets.ACR_PASSWORD)'

      # 2) Build Ø§ÛŒÙ…ÛŒØ¬
      - name: Build image aspsimple:v1.0
        run: docker build -t eshopweb2025.azurecr.io/aspsimple:v1.0 .

      # 3) Push Ø§ÛŒÙ…ÛŒØ¬
      - name: Push image
        run: docker push eshopweb2025.azurecr.io/aspsimple:v1.0

      # 4) ØµØ¨Ø± 2 Ø¯Ù‚ÛŒÙ‚Ù‡ ØªØ§ Web App Ø§ÛŒÙ…ÛŒØ¬ Ø±Ùˆ Ø¨Ú©Ø´Ù‡
      - name: Wait 2 minutes for Web App pull
        run: |
          echo "â³ Waiting 120s for Web App to pull the new image..."
          sleep 120

      # 5) ØªØ³Øª Ø®Ø±ÙˆØ¬ÛŒ Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 8080
      #    Ø¢Ø¯Ø±Ø³ ÙˆØ¨â€ŒØ§Ù¾Øª Ø±Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†
      - name: Probe port 8080
        run: |
          echo "ğŸ” Probing http://eshop-webapp.azurewebsites.net:8080 ..."
          curl -v http://eshop-webapp.azurewebsites.net:8080 || exit 1