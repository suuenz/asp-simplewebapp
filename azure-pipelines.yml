# azure-pipelines.yml

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  acrName: 'aspsimplewebapp'              # Ù†Ø§Ù… ACR
  imageName: 'aspsimple'               # Ù†Ø§Ù… Ø§ÛŒÙ…ÛŒØ¬
  imageTag: 'v1.0'                     # ØªÚ¯
  webAppName: 'asp-webapp-1'           # Ù†Ø§Ù… Web App
  resourceGroup: 'DefaultResourceGroup-CUS'   # RG ÙˆØ¨â€ŒØ§Ù¾

steps:
- checkout: self

# 1) Build & Push Ø¯Ø± Ø®ÙˆØ¯ ACR (Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Docker@2 Ùˆ Ù„Ø§Ú¯ÛŒÙ† ACR Ù†ÛŒØ³Øª)
- task: AzureCLI@2
  displayName: 'Build & Push image in ACR (az acr build)'
  inputs:
    azureSubscription: 'Azure subscription 1 (2edd3441-9535-4384-9f66-2e3fad269e4c)'   # Service Connection Ù†ÙˆØ¹ ARM
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      echo "ğŸ”§ Building image $(imageName):$(imageTag) in ACR $(acrName)..."
      az acr build \
        --registry $(acrName) \
        --image $(imageName):$(imageTag) \
        --file Dockerfile \
        .
      echo "âœ… Image pushed: $(acrName).azurecr.io/$(imageName):$(imageTag)"

# 2) Deploy: ØªÙ†Ø¸ÛŒÙ… Ø§ÛŒÙ…ÛŒØ¬ Ø±ÙˆÛŒ Web App
- task: AzureCLI@2
  displayName: 'Deploy image to Web App (az cli)'
  inputs:
    azureSubscription: 'Azure subscription 1 (2edd3441-9535-4384-9f66-2e3fad269e4c)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      echo "âš™ï¸  Configuring container image on Web App..."
      az webapp config container set \
        --name $(webAppName) \
        --resource-group $(resourceGroup) \
        --docker-custom-image-name $(acrName).azurecr.io/$(imageName):$(imageTag) \
        --docker-registry-server-url https://$(acrName).azurecr.io

      echo "ğŸ”§ Ensuring WEBSITES_PORT=8080"
      az webapp config appsettings set \
        --name $(webAppName) \
        --resource-group $(resourceGroup) \
        --settings WEBSITES_PORT=8080

      echo "ğŸ”„ Restarting Web App..."
      az webapp restart --name $(webAppName) --resource-group $(resourceGroup)

# 3) Probe Ù¾ÙˆØ±Øª 8080 ØªØ§ 60 Ø«Ø§Ù†ÛŒÙ‡ 
- bash: |
    echo "â³ Waiting up to 60s probing :8080"
    sleep 60
  displayName: 'Probe 8080'