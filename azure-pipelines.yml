# azure-pipelines.yml
# Build (az acr build) ‚Üí Deploy (az webapp config container set) ‚Üí Probe :8080
# ÿ®ÿØŸàŸÜ Docker ÿ±Ÿà€å Agentÿå ÿ®ÿØŸàŸÜ Admin User Ÿà ÿ®ÿØŸàŸÜ Publish Profile

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  acrName: 'eshopweb2025'              # ŸÜÿßŸÖ ACR
  imageName: 'aspsimple'               # ŸÜÿßŸÖ ÿß€åŸÖ€åÿ¨
  imageTag: 'v1.0'                     # ÿ™⁄Ø
  webAppName: 'eshop-webapp'           # ŸÜÿßŸÖ Web App
  resourceGroup: 'DefaultResourceGroup-CUS'   # RG Ÿàÿ®‚ÄåÿßŸæ

steps:
- checkout: self

# 1) Build & Push ÿØÿ± ÿÆŸàÿØ ACR (ŸÜ€åÿßÿ≤€å ÿ®Ÿá Docker@2 Ÿà ŸÑÿß⁄Ø€åŸÜ ACR ŸÜ€åÿ≥ÿ™)
- task: AzureCLI@2
  displayName: 'Build & Push image in ACR (az acr build)'
  inputs:
    azureSubscription: 'Azure subscription 1 (2edd3441-9535-4384-9f66-2e3fad269e4c)'   # Service Connection ŸÜŸàÿπ ARM
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      echo "üîß Building image $(imageName):$(imageTag) in ACR $(acrName)..."
      az acr build \
        --registry $(acrName) \
        --image $(imageName):$(imageTag) \
        --file Dockerfile \
        .
      echo "‚úÖ Image pushed: $(acrName).azurecr.io/$(imageName):$(imageTag)"

# 2) Deploy: ÿ™ŸÜÿ∏€åŸÖ ÿß€åŸÖ€åÿ¨ ÿ±Ÿà€å Web App
- task: AzureCLI@2
  displayName: 'Deploy image to Web App (az cli)'
  inputs:
    azureSubscription: 'Azure subscription 1 (2edd3441-9535-4384-9f66-2e3fad269e4c)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      set -e
      echo "‚öôÔ∏è  Configuring container image on Web App..."
      az webapp config container set \
        --name $(webAppName) \
        --resource-group $(resourceGroup) \
        --docker-custom-image-name $(acrName).azurecr.io/$(imageName):$(imageTag) \
        --docker-registry-server-url https://$(acrName).azurecr.io

      echo "üîß Ensuring WEBSITES_PORT=8080"
      az webapp config appsettings set \
        --name $(webAppName) \
        --resource-group $(resourceGroup) \
        --settings WEBSITES_PORT=8080

      echo "üîÑ Restarting Web App..."
      az webapp restart --name $(webAppName) --resource-group $(resourceGroup)

# 3) Probe ŸæŸàÿ±ÿ™ 8080 ÿ™ÿß 120 ÿ´ÿßŸÜ€åŸá (Ÿáÿ± 5 ÿ´ÿßŸÜ€åŸá)
- bash: |
    echo "‚è≥ Waiting up to 120s for warm-up & probing :8080"
    for i in {1..24}; do
      if curl -fsS "http://$(webAppName).azurewebsites.net:8080" >/dev/null; then
        echo "‚úÖ Up on :8080"
        exit 0
      fi
      echo "‚Ä¶still waiting ($i/24)"
      sleep 5
    done
    echo "‚ùå No response on :8080 within 120s"
    exit 1
  displayName: 'Warm-up & Probe 8080'